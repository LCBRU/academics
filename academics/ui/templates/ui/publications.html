{% extends "ui/page.html" %}
{% from "lbrc_flask/form_macros.html" import render_search, render_pagination, pagination_summary %}
{% from "lbrc_flask/modal_macros.html" import render_modal %}
{% from "ui/_publication_details.html" import render_publication_title, render_publication_folders, render_publication_authors, render_publication_attributes, render_publication_funding, render_publication_abstract, render_publication_keywords %}


{% block content %}
<section>
    <div class="page-header">
        <h1>Publications</h1>

        {{ render_search(
            search_form,
            'ui.publications',
            placeholder='enter search text - searches title, journal or DOI',
            buttons=[
                {
                    'text': 'Full Export',
                    'endpoint': 'ui.publication_full_export_xlsx',
                    'add_form_fields': True,
                },
                {
                    'text': 'Annual Report',
                    'endpoint': 'ui.publication_full_annual_report_xlsx',
                    'add_form_fields': True,
                },
                {
                    'text': 'PDF',
                    'endpoint': 'ui.publication_export_pdf',
                    'add_form_fields': True,
                    'disabled': publications.total > 100,
                },
            ],
        ) }}
    </div>

    {{ pagination_summary(publications, 'publication') }}

    <ul class="list-group">
        {% for p in publications.items %}
            <li class="list-group-item summary_details">
                <h1>Goo</h1>
                <h2>{{ p.title }}</h2>
                {{ render_publication_title(p) }}
                {{ render_publication_authors(p) }}
                {{ render_publication_attributes(p, current_user, nihr_acknowledgements) }}
                {{ render_publication_funding(p) }}
                {{ render_publication_abstract(p) }}
                {{ render_publication_keywords(p) }}
                <div id="publication_folders_{{p.id}}">
                    {{ render_publication_folders(p, folders) }}
                </div>
            </li>
        {% endfor %}
    </ul>
</section>

{{ render_pagination(publications, 'ui.publications', form=search_form) }}

{% endblock %}

{% block js %}

<script>
    document.querySelectorAll('.search-filters input, .search-filters select').forEach(function(f){
        f.addEventListener('change', onChangeHandler);
    })

    function onChangeHandler() {
        document.querySelectorAll('form a[href^="/publications/export"]').forEach(function(f){
            f.removeAttribute('href');
            f.classList.add("disabled");
            f.title = "disabled";
        })
    }
    
    async function folder_remove_publication() {
        var button = $(window.event.target);

        let response = await fetch("{{ url_for('ui.folder_remove_publication') }}", {
            method: 'post',
            headers: {"Content-type": "application/json; charset=UTF-8"},
            body: JSON.stringify({
                folder_id: button.data('folder-id'),
                publication_id: button.data('publication-id'),
            }),
        });

        await replace_publications_folders(button.data('publication-id'));
    }

    async function folder_add_publication() {
        var button = $(window.event.target);

        let response = await fetch("{{ url_for('ui.folder_add_publication') }}", {
            method: 'post',
            headers: {"Content-type": "application/json; charset=UTF-8"},
            body: JSON.stringify({
                folder_id: button.data('folder-id'),
                publication_id: button.data('publication-id'),
            }),
        })
        
        await replace_publications_folders(button.data('publication-id'));
    }

    async function replace_publications_folders(publication_id) {
        let response = await fetch("{{ url_for('ui.publication_folders') }}", {
            method: 'post',
            headers: {"Content-type": "application/json; charset=UTF-8"},
            body: JSON.stringify({
                id: publication_id,
            }),
        })
        let data = await response.text();
        document.getElementById(`publication_folders_${publication_id}`).innerHTML = data;
    }
</script>

{% endblock %}
